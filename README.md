# NeuronDownloader

Телеграм-бот на PyTelegramBotAPI из экосистемы канала «Банка с нейронами». Это Нейрон Downloader — сервис благодарности и помощи подписчикам. На канале я рассказываю про ИИ технологии простым языком для нетехнической аудитории. Бот принимает ссылки на YouTube, Instagram или VK Видео, предлагает варианты качества и скачивает видео вместе с описанием. YouTube — основной приоритет, но поддерживаются и Instagram/VK ссылки.

## Возможности

- Приём ссылок и выбор качества через инлайн-кнопки (YouTube/Instagram/VK).
- Загрузка видео с описанием (caption отдельным сообщением).
- Подписка на канал YouTube и автоматическое скачивание новых публикаций в выбранном разрешении.
- Если выбранное разрешение недоступно, бот качает максимально доступное качество.
- Очередь загрузок: одновременно выполняется ограниченное число скачиваний.
- Админка: статистика, список пользователей, блокировка.
- Контроль доступа: можно требовать подписку на обязательные чаты/каналы.

## Быстрый старт (без Docker)

**Команда для запуска** (из корня проекта, с активированным venv или через pipenv):

```bash
python -m app.main
```

Через pipenv: `pipenv run python -m app.main`. Модуль указывается без `.py`.

### Вариант 1: pipenv

1. Установите pipenv (если ещё не установлен):
   ```bash
   pip install pipenv
   ```
2. Создайте окружение и установите зависимости:
   ```bash
   pipenv install -r requirements.txt
   ```
3. Скопируйте `.env.example` в `.env` и заполните `BOT_TOKEN`.
4. Запустите бота:
   ```bash
   pipenv run python -m app.main
   ```

### Вариант 2: venv

1. Создайте виртуальное окружение и активируйте его:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   ```
2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Скопируйте `.env.example` в `.env` и заполните `BOT_TOKEN`.
4. Запустите бота:
   ```bash
   python -m app.main
   ```

## Примеры взаимодействия

- **Скачать видео:** отправьте ссылку на YouTube/Instagram/VK → бот покажет кнопки качества → выберите разрешение.
- **Подписаться:** после получения списка качества нажмите кнопку «Подписаться 720p» (или другую).
- **Отписаться:** нажмите кнопку «Отписаться» под сообщением о подписке.
- **Управление подписками:** команда `/subscriptions` покажет список и кнопки удаления.
- **Главное меню:** кнопки под полем ввода позволяют открыть подписки или помощь.
- **Поддержка разработчика:** без подписки на обязательные ресурсы доступно одно скачивание в день.

## Админка

Доступ предоставляется ID из `ADMIN_IDS`.

Команды:

- `/stats` — общая статистика и счетчики по пользователям.
- `/users` — список пользователей и статусы.
- `/block <user_id>` — заблокировать пользователя.
- `/unblock <user_id>` — разблокировать пользователя.

## Интерфейс и управление сообщениями

- Основные действия доступны через кнопки под полем ввода (reply-клавиатура).
- Инлайн-кнопки используются для выбора качества и управления подписками.
- При нажатии инлайн-кнопок бот редактирует текущее сообщение, а не создаёт новое.
- Команда `/start` сбрасывает диалог и удаляет кнопки из последнего сообщения с инлайн-клавиатурой.

## Ограничения для неподписанных пользователей

Если пользователь не подписан на обязательные ресурсы из `REQUIRED_CHAT_IDS`, доступно одно скачивание в день. Бот сообщает об этом в формате «поддержите разработчика» и предлагает оформить подписку для снятия ограничения.

## Бест-практики реализации

- **Разделение ответственности:** логика скачивания, хранения и мониторинга подписок разнесена по модулям (`app/downloader.py`, `app/storage.py`, `app/subscriptions.py`).
- **Минимальное хранение:** в БД сохраняются только ID последнего видео и выбранное разрешение.
- **Фоновая проверка:** подписки проверяются отдельным потоком с настраиваемым интервалом.
- **Ограничения Telegram:** для крупных файлов возможны лимиты Telegram, поэтому рекомендуется настроить загрузку в приемлемом качестве.
- **Приоритет YouTube:** подписки ориентированы на каналы YouTube, остальные платформы обрабатываются как одноразовые ссылки.
- **Очередь скачиваний:** количество параллельных загрузок регулируется переменной `MAX_CONCURRENT_DOWNLOADS`.

## Настройка подписок

Бот хранит подписки в SQLite (`DATA_DIR/bot.db`). Проверка новых публикаций происходит каждые `POLL_INTERVAL_SECONDS`.

## Примечания

- Для работы с Instagram и VK требуется актуальная версия `yt-dlp` и доступ к ресурсам. Для закрытых страниц/видео используйте cookies.
- Для частных видео/каналов YouTube нужны дополнительные настройки (cookies).

### Cookies для Instagram/VK/YouTube

Если YouTube выдаёт ошибку **«Sign in to confirm you're not a bot»**, нужен файл cookies авторизованного аккаунта.

1. Войдите в YouTube в браузере (Chrome/Firefox).
2. Установите расширение для экспорта cookies в формате Netscape, например:
   - [cookies.txt](https://github.com/rotemdan/ExportCookies) (Chrome/Firefox),
   - или «Get cookies.txt LOCALLY».
3. Откройте youtube.com и экспортируйте cookies в файл (например, `cookies.txt`).
4. В `.env` укажите абсолютный путь к файлу:

```bash
COOKIES_FILE=/path/to/cookies.txt
```

Перезапустите бота и повторите попытку.

## Настройки окружения

- `BOT_TOKEN` — токен бота Telegram.
- `DATA_DIR` — каталог для базы и загруженных файлов.
- `POLL_INTERVAL_SECONDS` — интервал проверки новых видео.
- `COOKIES_FILE` — путь к cookies для приватных видео/аккаунтов.
- `ADMIN_IDS` — список ID администраторов через запятую.
- `REQUIRED_CHAT_IDS` — обязательные чаты/каналы через запятую.
- `MAX_CONCURRENT_DOWNLOADS` — максимальное число параллельных загрузок.
- `YOUTUBE_PLAYER_CLIENTS` — список клиентов YouTube через запятую. Рекомендуемые значения: `android,web`.
  Поддерживаемые варианты (зависят от версии `yt-dlp`): `default`, `all`, `android`, `android_creator`, `ios`,
  `web`, `web_creator`, `mweb`, `tv`, `tv_embedded`. Если возникают ошибки, попробуйте убрать `android_creator`.
- `YOUTUBE_JS_RUNTIME` — имя JS-рантайма для обработки подписи (например, `node`, `deno`, `bun`).
- `YOUTUBE_JS_RUNTIME_PATH` — путь к бинарнику JS-рантайма (например, `/usr/bin/node`).
- `TELEBOT_LOG_LEVEL` — уровень логирования для `TeleBot`/`telebot` (по умолчанию `CRITICAL`).
- `TELEGRAM_POLLING_ERROR_DELAY_SECONDS` — базовая пауза перед повтором polling при ошибках (секунды).
- `TELEGRAM_POLLING_DNS_DELAY_SECONDS` — пауза перед повтором при проблемах с DNS (секунды).
