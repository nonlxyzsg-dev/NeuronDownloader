# NeuronDownloader

Телеграм-бот на PyTelegramBotAPI из экосистемы канала «Банка с нейронами». Это Нейрон Downloader — сервис благодарности и помощи подписчикам. На канале я рассказываю про ИИ технологии простым языком для нетехнической аудитории. Бот принимает ссылки на YouTube, Instagram или VK Видео, предлагает варианты качества и скачивает видео вместе с описанием. YouTube — основной приоритет, но поддерживаются и Instagram/VK ссылки.

## Возможности

- Приём ссылок и выбор качества через инлайн-кнопки (YouTube/Instagram/VK).
- Загрузка видео с описанием (caption отдельным сообщением).
- Подписка на канал YouTube и автоматическое скачивание новых публикаций в выбранном разрешении.
- Если выбранное разрешение недоступно, бот качает максимально доступное качество.
- Очередь загрузок: одновременно выполняется ограниченное число скачиваний.
- Админка: статистика, список пользователей, блокировка.
- Контроль доступа: можно требовать подписку на обязательные чаты/каналы.

## Требования

- Python 3.12 или выше
- Node.js 18.x или выше (для корректной работы yt-dlp с YouTube)
- pipenv (рекомендуется) или venv

## Установка

### Шаг 1: Установка системных зависимостей

Установите Node.js для поддержки JavaScript runtime в yt-dlp:

```bash
sudo apt update && sudo apt install nodejs
```

Проверьте установку:

```bash
node --version  # Должно показать версию 18.x или выше
```

### Шаг 2: Установка pipenv (если не установлен)

```bash
pip install --user pipenv
```

### Шаг 3: Клонирование и настройка проекта

```bash
# Перейдите в директорию проекта
cd /path/to/NeuronDownloader

# Установите зависимости через pipenv (автоматически создаст виртуальное окружение)
pipenv install

# Проверьте версию yt-dlp
pipenv run yt-dlp --version  # Должно показать 2026.1.31 или новее
```

### Шаг 4: Настройка окружения

Скопируйте файл с примером настроек и заполните необходимые параметры:

```bash
cp .env.example .env
```

Обязательно укажите в `.env`:
- `BOT_TOKEN` — токен вашего Telegram-бота (получить у [@BotFather](https://t.me/BotFather))
- `ADMIN_IDS` — ваш Telegram ID (узнать у [@userinfobot](https://t.me/userinfobot))

### Шаг 5: Запуск бота

**Вариант 1: Через pipenv run (рекомендуется)**

```bash
pipenv run python -m app.main
```

**Вариант 2: С активацией виртуального окружения**

```bash
pipenv shell
python -m app.main
```

Для выхода из виртуального окружения используйте команду `exit`.

### Альтернативный способ: установка через venv

Если вы предпочитаете использовать стандартный venv вместо pipenv:

```bash
# Создайте виртуальное окружение
python3 -m venv .venv

# Активируйте его
source .venv/bin/activate  # Linux/macOS
# или
.venv\Scripts\activate  # Windows

# Установите зависимости
pip install -r requirements.txt

# Запустите бота
python -m app.main
```

### Проверка установки

После запуска бот должен вывести сообщение:

```
INFO | Бот запущен. Ожидание сообщений...
```

Отправьте боту команду `/start` в Telegram — если всё настроено правильно, бот ответит приветственным сообщением.

## Примеры взаимодействия

- **Скачать видео:** отправьте ссылку на YouTube/Instagram/VK → бот покажет кнопки качества → выберите разрешение.
- **Подписаться:** после получения списка качества нажмите кнопку «Подписаться 720p» (или другую).
- **Отписаться:** нажмите кнопку «Отписаться» под сообщением о подписке.
- **Управление подписками:** команда `/subscriptions` покажет список и кнопки удаления.
- **Главное меню:** кнопки под полем ввода позволяют открыть подписки или помощь.
- **Поддержка разработчика:** без подписки на обязательные ресурсы доступно одно скачивание в день.

## Админка

Доступ предоставляется ID из `ADMIN_IDS`.

Команды:

- `/stats` — общая статистика и счетчики по пользователям.
- `/users` — список пользователей и статусы.
- `/block <user_id>` — заблокировать пользователя.
- `/unblock <user_id>` — разблокировать пользователя.

## Интерфейс и управление сообщениями

- Основные действия доступны через кнопки под полем ввода (reply-клавиатура).
- Инлайн-кнопки используются для выбора качества и управления подписками.
- При нажатии инлайн-кнопок бот редактирует текущее сообщение, а не создаёт новое.
- Команда `/start` сбрасывает диалог и удаляет кнопки из последнего сообщения с инлайн-клавиатурой.

## Ограничения для неподписанных пользователей

Если пользователь не подписан на обязательные ресурсы из `REQUIRED_CHAT_IDS`, доступно одно скачивание в день. Бот сообщает об этом в формате «поддержите разработчика» и предлагает оформить подписку для снятия ограничения.

## Бест-практики реализации

- **Разделение ответственности:** логика скачивания, хранения и мониторинга подписок разнесена по модулям (`app/downloader.py`, `app/storage.py`, `app/subscriptions.py`).
- **Минимальное хранение:** в БД сохраняются только ID последнего видео и выбранное разрешение.
- **Фоновая проверка:** подписки проверяются отдельным потоком с настраиваемым интервалом.
- **Ограничения Telegram:** для крупных файлов возможны лимиты Telegram, поэтому рекомендуется настроить загрузку в приемлемом качестве.
- **Приоритет YouTube:** подписки ориентированы на каналы YouTube, остальные платформы обрабатываются как одноразовые ссылки.
- **Очередь скачиваний:** количество параллельных загрузок регулируется переменной `MAX_CONCURRENT_DOWNLOADS`.

## Настройка подписок

Бот хранит подписки в SQLite (`DATA_DIR/bot.db`). Проверка новых публикаций происходит каждые `POLL_INTERVAL_SECONDS`.

## Обновление зависимостей

Для обновления yt-dlp до последней версии:

```bash
# Через pipenv
pipenv update yt-dlp

# Или обновить все пакеты
pipenv update

# Проверить установленную версию
pipenv run yt-dlp --version
```

Через venv:

```bash
source .venv/bin/activate
pip install --upgrade yt-dlp
yt-dlp --version
```

## Примечания

- Для работы с Instagram и VK требуется актуальная версия `yt-dlp` (2026.1.31 или новее) и доступ к ресурсам. Для закрытых страниц/видео используйте cookies.
- Для частных видео/каналов YouTube нужны дополнительные настройки (cookies).
- Node.js необходим для корректной работы с YouTube — без него возможны ошибки "Sign in to confirm you're not a bot".

### Cookies для Instagram/VK/YouTube

Если YouTube выдаёт ошибку **«Sign in to confirm you're not a bot»**, нужен файл cookies авторизованного аккаунта.

1. Войдите в YouTube в браузере (Chrome/Firefox).
2. Установите расширение для экспорта cookies в формате Netscape, например:
   - [cookies.txt](https://github.com/rotemdan/ExportCookies) (Chrome/Firefox),
   - или «Get cookies.txt LOCALLY».
3. Откройте youtube.com и экспортируйте cookies в файл (например, `cookies.txt`).
4. В `.env` укажите абсолютный путь к файлу:

```bash
COOKIES_FILE=/path/to/cookies.txt
```

Перезапустите бота и повторите попытку.

## Устранение типичных проблем

### yt-dlp не найден

**Проблема:** `Command 'yt-dlp' not found`

**Решение:** 
- Убедитесь, что вы запускаете бота через `pipenv run` или активировали виртуальное окружение
- Проверьте установку: `pipenv run yt-dlp --version`
- Переустановите зависимости: `pipenv install`

### Предупреждение "No supported JavaScript runtime"

**Проблема:** `WARNING | yt-dlp: [youtube] No supported JavaScript runtime could be found`

**Решение:**
```bash
# Установите Node.js
sudo apt update && sudo apt install nodejs

# Проверьте установку
node --version

# Перезапустите бота
```

### Ошибка "Sign in to confirm you're not a bot"

**Проблема:** YouTube требует авторизацию

**Решение:**
1. Установите Node.js (см. выше)
2. Если проблема сохраняется, используйте cookies (см. раздел "Cookies для Instagram/VK/YouTube")
3. Убедитесь, что используете актуальную версию yt-dlp: `pipenv run yt-dlp --version` (должна быть 2026.1.31 или новее)

### ModuleNotFoundError при запуске

**Проблема:** `ModuleNotFoundError: No module named 'telebot'`

**Решение:**
```bash
# Убедитесь, что зависимости установлены
pipenv install

# Запускайте через pipenv run
pipenv run python -m app.main
```

### Бот не отвечает на команды

**Проблема:** Бот запустился, но не реагирует на сообщения

**Решение:**
1. Проверьте правильность `BOT_TOKEN` в файле `.env`
2. Убедитесь, что файл `.env` находится в корне проекта
3. Проверьте логи на наличие ошибок подключения
4. Убедитесь, что бот не запущен в другом месте (конфликт polling)

## Настройки окружения

- `BOT_TOKEN` — токен бота Telegram.
- `DATA_DIR` — каталог для базы и загруженных файлов.
- `POLL_INTERVAL_SECONDS` — интервал проверки новых видео.
- `COOKIES_FILE` — путь к cookies для приватных видео/аккаунтов.
- `ADMIN_IDS` — список ID администраторов через запятую.
- `REQUIRED_CHAT_IDS` — обязательные чаты/каналы через запятую.
- `MAX_CONCURRENT_DOWNLOADS` — максимальное число параллельных загрузок.
- `YOUTUBE_PLAYER_CLIENTS` — список клиентов YouTube через запятую. Рекомендуемые значения: `android,web`.
  Поддерживаемые варианты (зависят от версии `yt-dlp`): `default`, `all`, `android`, `android_creator`, `ios`,
  `web`, `web_creator`, `mweb`, `tv`, `tv_embedded`. Если возникают ошибки, попробуйте убрать `android_creator`.
- `YOUTUBE_JS_RUNTIME` — имя JS-рантайма для обработки подписи (например, `node`, `deno`, `bun`).
- `YOUTUBE_JS_RUNTIME_PATH` — путь к бинарнику JS-рантайма (например, `/usr/bin/node`).
- `TELEBOT_LOG_LEVEL` — уровень логирования для `TeleBot`/`telebot` (по умолчанию `CRITICAL`).
- `TELEGRAM_POLLING_ERROR_DELAY_SECONDS` — базовая пауза перед повтором polling при ошибках (секунды).
- `TELEGRAM_POLLING_DNS_DELAY_SECONDS` — пауза перед повтором при проблемах с DNS (секунды).
